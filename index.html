<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LITORAL 900 - Dashboard de Control de Calidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .bar { transition: all 0.3s ease; }
        .bar:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ============ THEME ============
        const THEME = {
            primary: '#0f172a',
            success: '#059669',
            danger: '#be123c',
            warning: '#f59e0b',
            info: '#3b82f6',
            neutral: '#64748b'
        };

        const COLORS_PRIORITY = {
            'Urgent': THEME.danger,
            'High': THEME.warning,
            'Medium': THEME.info,
            'Low': THEME.neutral
        };

        const COLORS_STATUS = {
            'Cerrado': THEME.success,
            'Iniciado': THEME.warning,
            'Abierto': THEME.danger,
            'Listo para revisi√≥n': THEME.info
        };

        // ============ HELPERS ============
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                let year = parseInt(parts[2], 10);
                if (year < 100) year += 2000;
                return new Date(year, month, day);
            }
            return new Date(dateStr);
        };

        // Funci√≥n para extraer ubicaci√≥n seg√∫n categor√≠as espec√≠ficas
        const extractUbicacion = (locUpper, locParts) => {
            // Buscar coincidencias espec√≠ficas
            for (const part of locParts) {
                const upper = part.toUpperCase().trim();
                
                // PISO con n√∫mero (PISO 1, PISO 2, etc.)
                const pisoMatch = upper.match(/PISO\s*(\d+)/);
                if (pisoMatch) {
                    return `PISO ${pisoMatch[1]}`;
                }
                
                // SOTANO con n√∫mero
                const sotanoMatch = upper.match(/S[O√ì]TANO\s*(\d*)/);
                if (sotanoMatch) {
                    return sotanoMatch[1] ? `SOTANO ${sotanoMatch[1]}` : 'SOTANO';
                }
            }
            
            // Buscar en string completo
            if (locUpper.includes('ANILLO')) return 'ANILLO';
            if (locUpper.includes('CISTERNA')) return 'CISTERNA';
            if (locUpper.includes('AZOTEA')) return 'AZOTEA';
            if (locUpper.includes('TECHO')) return 'TECHO';
            
            // PISO en string completo
            const pisoMatch = locUpper.match(/PISO\s*(\d+)/);
            if (pisoMatch) return `PISO ${pisoMatch[1]}`;
            
            // SOTANO en string completo
            const sotanoMatch = locUpper.match(/S[O√ì]TANO\s*(\d*)/);
            if (sotanoMatch) return sotanoMatch[1] ? `SOTANO ${sotanoMatch[1]}` : 'SOTANO';
            
            return 'Sin definir';
        };

        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentVal = '';
            let inQuotes = false;

            const cleanText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let i = 0; i < cleanText.length; i++) {
                const char = cleanText[i];
                const nextChar = cleanText[i + 1];

                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentVal += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentVal += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentVal.trim());
                        currentVal = '';
                    } else if (char === '\n') {
                        currentRow.push(currentVal.trim());
                        if (currentRow.some(c => c !== '')) rows.push(currentRow);
                        currentRow = [];
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
            }

            if (currentVal || currentRow.length > 0) {
                currentRow.push(currentVal.trim());
                if (currentRow.some(c => c !== '')) rows.push(currentRow);
            }

            if (rows.length < 2) return [];

            const headers = rows[0].map(h => h.trim().replace(/^"|"$/g, ''));
            const result = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < Math.floor(headers.length * 0.5)) continue;

                const obj = {};
                headers.forEach((h, idx) => {
                    obj[h] = row[idx] || '';
                });

                obj._dateObj = parseDate(obj['Fecha de notificaci√≥n'] || obj['Fecha de creaci√≥n']);

                const locString = obj['Ubicaci√≥n'] || '';
                const locParts = locString.split('>').map(s => s.trim());
                const locUpper = locString.toUpperCase();

                obj._torre = locParts[0] || 'General';
                
                // Extraer ubicaci√≥n espec√≠fica seg√∫n categor√≠as
                obj._piso = extractUbicacion(locUpper, locParts);

                obj._departamento = locParts.find(p => {
                    const upper = p.toUpperCase();
                    return upper.includes('DPTO') || upper.includes('DP');
                }) || '';

                const specString = obj['Especialidad'] || '';
                const specMatch = specString.match(/^(\d+)/);
                obj._partidaCode = specMatch ? specMatch[1] : 'S/C';
                obj._partidaName = specString.replace(/^\d+\s-\s/, '').split('-')[0].trim();

                obj._tipoLabel = obj['Tipo'] || 'Otros';

                result.push(obj);
            }
            return result;
        };

        // ============ APP STATE ============
        let appData = [];
        let fileName = '';
        let filterType = 'All';
        let currentPage = 1;
        const itemsPerPage = 20;
        let timelineFilter = 'all'; // 'all', 'lastMonth', 'lastWeek'

        // Funci√≥n para calcular datos de l√≠nea de tiempo
        function calculateTimelineData(data, filter) {
            let filtered = data.filter(d => d._dateObj);
            
            // Aplicar filtro de tipo si est√° activo
            if (filterType !== 'All') {
                filtered = filtered.filter(d => d['Tipo'] === filterType);
            }
            
            // Aplicar filtro de tiempo
            const now = new Date();
            if (filter === 'lastMonth') {
                const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                filtered = filtered.filter(d => d._dateObj >= oneMonthAgo);
            } else if (filter === 'lastWeek') {
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(d => d._dateObj >= oneWeekAgo);
            }
            
            // Agrupar por fecha
            const dateMap = {};
            filtered.forEach(row => {
                const dateKey = row._dateObj.toISOString().split('T')[0];
                if (!dateMap[dateKey]) {
                    dateMap[dateKey] = { total: 0, cerrado: 0, abierto: 0, iniciado: 0 };
                }
                dateMap[dateKey].total++;
                const status = (row['Estatus'] || '').toLowerCase();
                if (status === 'cerrado') dateMap[dateKey].cerrado++;
                else if (status === 'abierto') dateMap[dateKey].abierto++;
                else if (status === 'iniciado') dateMap[dateKey].iniciado++;
            });
            
            // Ordenar por fecha
            const sortedDates = Object.keys(dateMap).sort();
            return sortedDates.map(date => ({
                date,
                displayDate: new Date(date).toLocaleDateString('es-PE', { day: '2-digit', month: 'short' }),
                ...dateMap[date]
            }));
        }

        // ============ RENDER FUNCTIONS ============
        function renderUploadScreen() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-6">
                    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-12 text-center">
                        <div class="mb-8 flex justify-center">
                            <div class="h-20 w-20 bg-gradient-to-br from-slate-900 to-slate-800 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="text-white w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect x="3" y="2" width="18" height="20" rx="2" ry="2"></rect>
                                    <line x1="9" y1="2" x2="9" y2="22"></line>
                                    <line x1="15" y1="2" x2="15" y2="22"></line>
                                </svg>
                            </div>
                        </div>
                        <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">LITORAL 900</h1>
                        <p class="text-lg font-semibold text-slate-600 mt-2">Sistema de Control de Calidad</p>
                        <p class="text-sm text-slate-400 mt-1">An√°lisis en Tiempo Real de Observaciones</p>

                        <div class="mt-10 space-y-6">
                            <div class="p-10 border-2 border-dashed border-slate-300 rounded-xl hover:border-slate-800 hover:bg-slate-50 transition-all cursor-pointer relative group">
                                <input type="file" accept=".csv" id="fileInput" class="absolute inset-0 opacity-0 z-10 cursor-pointer" />
                                <svg class="mx-auto w-12 h-12 text-slate-400 group-hover:text-slate-800 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p class="mt-4 text-base font-semibold text-slate-700">Carga tu archivo CSV</p>
                                <p class="mt-1 text-sm text-slate-500">Exportado desde Procore</p>
                            </div>

                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-slate-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-slate-500 font-medium">O prueba con</span>
                                </div>
                            </div>

                            <button id="demoBtn" class="w-full py-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-xl font-bold text-lg hover:shadow-xl transition-all shadow-lg">
                                üìä Cargar Datos Demo
                            </button>
                        </div>
                        <p class="mt-8 text-xs text-slate-400">Dashboard profesional para Litoral 900</p>
                    </div>
                </div>
            `;
        }

        function calculateAnalytics(data, filter) {
            let filtered = data;
            if (filter !== 'All') {
                filtered = filtered.filter(d => d['Tipo'] === filter);
            }

            const total = filtered.length;
            const closed = filtered.filter(d => d['Estatus'] === 'Cerrado').length;
            const open = filtered.filter(d => d['Estatus'] === 'Abierto').length;
            const inProgress = filtered.filter(d => d['Estatus'] === 'Iniciado').length;
            const critical = filtered.filter(d => d['Prioridad'] === 'Urgent').length;

            const effectivenessRate = Math.round((closed / total) * 100) || 0;
            const criticalityIndex = Math.round((critical / total) * 100) || 0;

            // Status distribution
            const statusMap = {};
            filtered.forEach(row => {
                const status = row['Estatus'];
                statusMap[status] = (statusMap[status] || 0) + 1;
            });

            // Priority distribution
            const priorityMap = {};
            filtered.forEach(row => {
                const priority = row['Prioridad'];
                priorityMap[priority] = (priorityMap[priority] || 0) + 1;
            });

            // Floor distribution - ordenado seg√∫n lista espec√≠fica
            const floorMap = {};
            const floorOrder = [
                'ANILLO', 'CISTERNA', 
                'SOTANO 6', 'SOTANO 5', 'SOTANO 4', 'SOTANO 3', 'SOTANO 2', 'SOTANO 1', 'SOTANO',
                'AZOTEA',
                'PISO 1', 'PISO 2', 'PISO 3', 'PISO 4', 'PISO 5', 'PISO 6', 'PISO 7', 'PISO 8',
                'PISO 9', 'PISO 10', 'PISO 11', 'PISO 12', 'PISO 13', 'PISO 14', 'PISO 15',
                'TECHO', 'Sin definir'
            ];
            
            filtered.forEach(row => {
                let floor = row._piso;
                if (!floor || floor === 'Sin definir') floor = 'Sin definir';
                floorMap[floor] = (floorMap[floor] || 0) + 1;
            });
            
            // Ordenar seg√∫n lista predefinida
            const sortedFloorMap = {};
            floorOrder.forEach(f => {
                if (floorMap[f]) sortedFloorMap[f] = floorMap[f];
            });
            // Agregar cualquier ubicaci√≥n no listada
            Object.keys(floorMap).forEach(f => {
                if (!sortedFloorMap[f]) sortedFloorMap[f] = floorMap[f];
            });

            // Type distribution
            const tipoMap = {};
            filtered.forEach(row => {
                const tipo = row._tipoLabel;
                tipoMap[tipo] = (tipoMap[tipo] || 0) + 1;
            });

            return {
                total, closed, open, inProgress, critical,
                effectivenessRate, criticalityIndex,
                statusMap, priorityMap, floorMap: sortedFloorMap, tipoMap,
                raw: filtered
            };
        }

        function renderBarChart(data, maxVal, wide = false, chartType = 'floor') {
            return Object.entries(data).map(([name, value]) => {
                const width = Math.max((value / maxVal) * 100, 8);
                const labelWidth = wide ? 'w-48' : 'w-24';
                const pct = Math.round((value / Object.values(data).reduce((a,b) => a+b, 0)) * 100);
                const escapedName = name.replace(/'/g, "\\'");
                return `
                    <div class="flex items-center gap-3 mb-3 relative group">
                        <div class="${labelWidth} text-sm text-slate-700 font-medium" title="${name}">${name}</div>
                        <div class="flex-1 bg-slate-100 rounded-full h-7 overflow-hidden cursor-pointer"
                             onclick="showChartDetail('${chartType}', '${escapedName}')">
                            <div class="bar h-full bg-slate-700 rounded-full flex items-center justify-end pr-3 hover:bg-slate-600" style="width: ${width}%">
                                <span class="text-xs text-white font-bold">${value}</span>
                            </div>
                        </div>
                        <!-- Tooltip -->
                        <div class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-900 text-white text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none whitespace-nowrap shadow-lg">
                            <div class="font-bold">${name}</div>
                            <div class="text-slate-300">${value} observaciones (${pct}%)</div>
                            <div class="text-amber-400 text-[10px] mt-1">Click para ver detalle</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTimelineSection() {
            const timelineData = calculateTimelineData(appData, timelineFilter);
            
            if (timelineData.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-slate-800 text-lg mb-4">üìà L√≠nea de Tiempo de Observaciones</h3>
                        <p class="text-slate-500 text-center py-8">No hay datos de fechas disponibles para mostrar la l√≠nea de tiempo.</p>
                    </div>
                `;
            }
            
            const maxTotal = Math.max(...timelineData.map(d => d.total));
            const chartHeight = 200;
            const barWidth = Math.max(30, Math.min(60, 800 / timelineData.length));
            const chartWidth = timelineData.length * (barWidth + 10) + 60;
            
            // Calcular estad√≠sticas para el per√≠odo
            const totalObs = timelineData.reduce((sum, d) => sum + d.total, 0);
            const totalCerrado = timelineData.reduce((sum, d) => sum + d.cerrado, 0);
            const avgPerDay = (totalObs / timelineData.length).toFixed(1);
            
            return `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">üìà L√≠nea de Tiempo de Observaciones</h3>
                            <p class="text-xs text-slate-500">Evoluci√≥n de observaciones por fecha</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="setTimelineFilter('all')" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${timelineFilter === 'all' ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                                üìÖ Todo
                            </button>
                            <button onclick="setTimelineFilter('lastMonth')" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${timelineFilter === 'lastMonth' ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                                üìÜ √öltimo Mes
                            </button>
                            <button onclick="setTimelineFilter('lastWeek')" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${timelineFilter === 'lastWeek' ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                                üóìÔ∏è √öltima Semana
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas del per√≠odo -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-slate-50 rounded-lg p-3 text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold">Per√≠odo</p>
                            <p class="text-lg font-bold text-slate-800">${timelineData.length} d√≠as</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-3 text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold">Total en Per√≠odo</p>
                            <p class="text-lg font-bold text-slate-800">${totalObs} obs.</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-3 text-center">
                            <p class="text-xs text-slate-500 uppercase font-bold">Promedio/D√≠a</p>
                            <p class="text-lg font-bold text-slate-800">${avgPerDay}</p>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico de l√≠nea de tiempo -->
                    <div class="overflow-x-auto pb-4">
                        <div class="relative" style="min-width: ${chartWidth}px; height: ${chartHeight + 60}px;">
                            <!-- Grid lines -->
                            <div class="absolute inset-0" style="height: ${chartHeight}px;">
                                ${[0, 25, 50, 75, 100].map(pct => `
                                    <div class="absolute w-full border-t border-slate-100" style="top: ${pct}%; left: 40px; right: 0;">
                                        <span class="absolute -left-10 -top-2 text-xs text-slate-400 w-8 text-right">${Math.round(maxTotal * (100 - pct) / 100)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Bars -->
                            <div class="absolute flex items-end gap-2" style="left: 50px; bottom: 40px; height: ${chartHeight}px;">
                                ${timelineData.map((d, i) => {
                                    const totalHeight = (d.total / maxTotal) * chartHeight;
                                    const cerradoHeight = (d.cerrado / maxTotal) * chartHeight;
                                    const iniciadoHeight = (d.iniciado / maxTotal) * chartHeight;
                                    const abiertoHeight = (d.abierto / maxTotal) * chartHeight;
                                    
                                    return `
                                        <div class="relative group" style="width: ${barWidth}px;">
                                            <div class="flex flex-col-reverse" style="height: ${totalHeight}px;">
                                                <div class="bg-emerald-500 transition-all hover:opacity-80" style="height: ${cerradoHeight}px;" title="Cerrado: ${d.cerrado}"></div>
                                                <div class="bg-amber-500 transition-all hover:opacity-80" style="height: ${iniciadoHeight}px;" title="Iniciado: ${d.iniciado}"></div>
                                                <div class="bg-rose-500 transition-all hover:opacity-80" style="height: ${abiertoHeight}px;" title="Abierto: ${d.abierto}"></div>
                                            </div>
                                            <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity z-10 whitespace-nowrap pointer-events-none">
                                                ${d.displayDate}: ${d.total} obs.
                                            </div>
                                            <div class="text-xs text-slate-500 text-center mt-2 transform -rotate-45 origin-top-left translate-x-4" style="width: 60px;">${d.displayDate}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leyenda -->
                    <div class="flex items-center justify-center gap-6 mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-rose-500 rounded"></div>
                            <span class="text-xs text-slate-600">Abierto</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-amber-500 rounded"></div>
                            <span class="text-xs text-slate-600">Iniciado</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-emerald-500 rounded"></div>
                            <span class="text-xs text-slate-600">Cerrado</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatusChart(statusMap) {
            const colors = { 'Cerrado': '#059669', 'Iniciado': '#f59e0b', 'Abierto': '#be123c', 'Listo para revisi√≥n': '#3b82f6' };
            const total = Object.values(statusMap).reduce((a, b) => a + b, 0);
            
            return Object.entries(statusMap).map(([name, value]) => {
                const pct = Math.round((value / total) * 100);
                const color = colors[name] || '#64748b';
                const escapedName = name.replace(/'/g, "\\'");
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg mb-2 hover:bg-slate-100 cursor-pointer transition-colors group relative"
                         onclick="showChartDetail('status', '${escapedName}')">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                            <span class="text-sm font-medium text-slate-700">${name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-slate-900">${value}</span>
                            <span class="text-xs text-slate-500">(${pct}%)</span>
                        </div>
                        <!-- Tooltip -->
                        <div class="absolute right-0 top-full mt-1 bg-slate-900 text-white text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none whitespace-nowrap shadow-lg">
                            <div class="text-amber-400">Click para ver ${value} observaciones</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDashboard() {
            const analytics = calculateAnalytics(appData, filterType);
            const maxFloor = Math.max(...Object.values(analytics.floorMap));
            const maxTipo = Math.max(...Object.values(analytics.tipoMap));

            const types = ['All', ...new Set(appData.map(d => d['Tipo']))];

            return `
                <div class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
                    <!-- Header -->
                    <header class="bg-gradient-to-r from-slate-900 to-slate-800 text-white shadow-lg sticky top-0 z-30" style="border-bottom: 4px solid #d97706">
                        <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="bg-white/10 p-3 rounded-lg">
                                    <svg class="text-amber-400 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect x="3" y="2" width="18" height="20" rx="2" ry="2"></rect>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="font-bold text-2xl tracking-wide">LITORAL 900</h1>
                                    <p class="text-xs text-slate-300 uppercase tracking-widest">Dashboard de Control de Calidad</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <p class="text-xs text-slate-300 uppercase">Archivo</p>
                                    <p class="text-sm font-mono text-amber-300">${fileName.slice(0, 25)}${fileName.length > 25 ? '...' : ''}</p>
                                </div>
                                <label class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-xs font-bold uppercase rounded-lg cursor-pointer">
                                    üìÅ CSV
                                    <input type="file" accept=".csv" id="fileInputHeader" class="hidden" />
                                </label>
                            </div>
                        </div>
                    </header>

                    <main class="max-w-7xl mx-auto px-6 pt-8 pb-12 space-y-8">
                        <!-- Filters -->
                        <div class="flex flex-wrap gap-2 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            ${types.map(type => `
                                <button onclick="setFilter('${type}')" class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${filterType === type ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                                    ${type === 'All' ? 'üìä Todos' : type}
                                </button>
                            `).join('')}
                        </div>

                        <!-- KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 border-l-4 group relative cursor-help" style="border-left-color: #0f172a">
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Total Observaciones</p>
                                <h3 class="text-4xl font-extrabold text-slate-900 mt-2">${analytics.total}</h3>
                                <div class="absolute left-0 top-full mt-2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity z-50 w-64 shadow-lg pointer-events-none">
                                    <p class="font-bold text-amber-400 mb-1">üìä F√≥rmula:</p>
                                    <p>Conteo total de todas las observaciones en el sistema (filtradas por tipo si aplica).</p>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 border-l-4 group relative cursor-help" style="border-left-color: #be123c">
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Hallazgos Cr√≠ticos</p>
                                <h3 class="text-4xl font-extrabold text-rose-600 mt-2">${analytics.critical}</h3>
                                <div class="absolute left-0 top-full mt-2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity z-50 w-64 shadow-lg pointer-events-none">
                                    <p class="font-bold text-amber-400 mb-1">üìä F√≥rmula:</p>
                                    <p>Conteo de observaciones con Prioridad = "Urgent"</p>
                                    <p class="mt-1 text-slate-300">Actualmente: ${analytics.critical} de ${analytics.total}</p>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 border-l-4 group relative cursor-help" style="border-left-color: #059669">
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Efectividad</p>
                                <div class="flex items-baseline gap-1">
                                    <h3 class="text-4xl font-extrabold text-emerald-600 mt-2">${analytics.effectivenessRate}</h3>
                                    <span class="text-sm text-slate-500">%</span>
                                </div>
                                <div class="absolute left-0 top-full mt-2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity z-50 w-72 shadow-lg pointer-events-none">
                                    <p class="font-bold text-amber-400 mb-1">üìä F√≥rmula:</p>
                                    <p class="font-mono bg-slate-800 p-2 rounded mt-1">(Cerrados / Total) √ó 100</p>
                                    <p class="mt-2 text-slate-300">Actualmente: (${analytics.closed} / ${analytics.total}) √ó 100 = ${analytics.effectivenessRate}%</p>
                                    <p class="mt-2 text-emerald-400">‚Üë Mayor % = Mejor desempe√±o en cierre</p>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 border-l-4 group relative cursor-help" style="border-left-color: #f59e0b">
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">√çndice Criticidad</p>
                                <div class="flex items-baseline gap-1">
                                    <h3 class="text-4xl font-extrabold text-amber-600 mt-2">${analytics.criticalityIndex}</h3>
                                    <span class="text-sm text-slate-500">%</span>
                                </div>
                                <div class="absolute right-0 top-full mt-2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity z-50 w-72 shadow-lg pointer-events-none">
                                    <p class="font-bold text-amber-400 mb-1">üìä F√≥rmula:</p>
                                    <p class="font-mono bg-slate-800 p-2 rounded mt-1">(Cr√≠ticos / Total) √ó 100</p>
                                    <p class="mt-2 text-slate-300">Actualmente: (${analytics.critical} / ${analytics.total}) √ó 100 = ${analytics.criticalityIndex}%</p>
                                    <p class="mt-2 text-rose-400">‚Üë Mayor % = Mayor riesgo/urgencia</p>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                                <h3 class="font-bold text-slate-800 text-lg mb-4">üìç Distribuci√≥n por Nivel</h3>
                                <p class="text-xs text-slate-500 mb-3">Click en una barra para ver observaciones de ese nivel</p>
                                <div class="space-y-1">
                                    ${renderBarChart(analytics.floorMap, maxFloor, false, 'floor')}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                                <h3 class="font-bold text-slate-800 text-lg mb-4">üìä Estado de Observaciones</h3>
                                <p class="text-xs text-slate-500 mb-3">Click en un estado para filtrar</p>
                                <div>
                                    ${renderStatusChart(analytics.statusMap)}
                                </div>
                            </div>
                        </div>

                        <!-- Type Chart -->
                        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">üîß Distribuci√≥n por Tipo</h3>
                            <p class="text-xs text-slate-500 mb-3">Click en una barra para ver observaciones de ese tipo</p>
                            <div class="grid grid-cols-1 gap-2">
                                ${renderBarChart(analytics.tipoMap, maxTipo, true, 'tipo')}
                            </div>
                        </div>

                        <!-- Timeline Chart -->
                        ${renderTimelineSection()}

                        <!-- Modal para detalles de gr√°fico -->
                        <div id="chartDetailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                                <div class="p-4 bg-slate-900 text-white flex justify-between items-center">
                                    <h3 id="modalTitle" class="font-bold text-lg">Detalle</h3>
                                    <button onclick="closeChartDetail()" class="text-white hover:text-amber-400 text-2xl">&times;</button>
                                </div>
                                <div id="modalContent" class="p-4 overflow-y-auto max-h-[60vh]"></div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex items-center justify-between flex-wrap gap-2">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">üìã Desglose Detallado</h3>
                                    <span class="text-xs text-slate-500">Mostrando ${Math.min(currentPage * itemsPerPage, analytics.raw.length)} de ${analytics.raw.length} observaciones</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="changePage(-1)" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">‚Üê Anterior</button>
                                    <span class="text-sm text-slate-600">P√°gina ${currentPage} de ${Math.ceil(analytics.raw.length / itemsPerPage)}</span>
                                    <button onclick="changePage(1)" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium ${currentPage >= Math.ceil(analytics.raw.length / itemsPerPage) ? 'opacity-50 cursor-not-allowed' : ''}">Siguiente ‚Üí</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-slate-600">
                                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="px-4 py-4 w-8"></th>
                                            <th class="px-4 py-4">ID</th>
                                            <th class="px-4 py-4">Tipo</th>
                                            <th class="px-4 py-4">Ubicaci√≥n</th>
                                            <th class="px-4 py-4">Prioridad</th>
                                            <th class="px-4 py-4">Estado</th>
                                            <th class="px-4 py-4">Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${analytics.raw.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage).map((row, idx) => {
                                            const realIdx = (currentPage - 1) * itemsPerPage + idx;
                                            return `
                                            <tr class="hover:bg-slate-50 transition-colors cursor-pointer" onclick="toggleRow(${realIdx})">
                                                <td class="px-4 py-3 text-slate-400">
                                                    <svg id="arrow-${realIdx}" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                    </svg>
                                                </td>
                                                <td class="px-4 py-3 font-mono text-xs font-bold">#${row['N√∫mero'] || 'N/A'}</td>
                                                <td class="px-4 py-3 text-xs">
                                                    <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-bold">${row._tipoLabel}</span>
                                                </td>
                                                <td class="px-4 py-3 text-xs font-semibold">${row._piso}</td>
                                                <td class="px-4 py-3" style="color: ${COLORS_PRIORITY[row['Prioridad']] || '#64748b'}">
                                                    <span class="text-xs font-bold">${row['Prioridad'] || 'N/A'}</span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="text-xs font-semibold" style="color: ${COLORS_STATUS[row['Estatus']] || '#64748b'}">
                                                        ${row['Estatus'] || 'N/A'}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-xs text-slate-400">
                                                    ${row._dateObj ? row._dateObj.toLocaleDateString('es-PE') : 'N/A'}
                                                </td>
                                            </tr>
                                            <tr id="detail-${realIdx}" class="hidden bg-slate-50">
                                                <td colspan="7" class="px-6 py-4">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                                                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">üìù T√≠tulo / Descripci√≥n</p>
                                                            <p class="text-slate-800 font-medium">${row['T√≠tulo'] || row['Descripci√≥n'] || 'Sin t√≠tulo'}</p>
                                                        </div>
                                                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                                                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">üë§ Persona Asignada</p>
                                                            <p class="text-slate-800 font-medium">${row['Persona asignada'] || 'Sin asignar'}</p>
                                                            <p class="text-xs text-slate-500 mt-1">${row['Compa√±√≠a de la persona asignada'] || ''}</p>
                                                        </div>
                                                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                                                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">üìç Ubicaci√≥n Completa</p>
                                                            <p class="text-slate-800 font-medium">${row['Ubicaci√≥n'] || 'Sin ubicaci√≥n'}</p>
                                                        </div>
                                                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                                                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">üîß Especialidad</p>
                                                            <p class="text-slate-800 font-medium">${row['Especialidad'] || 'Sin especialidad'}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        // ============ MAIN RENDER ============
        function render() {
            const root = document.getElementById('root');
            if (appData.length === 0) {
                root.innerHTML = renderUploadScreen();
                setupUploadListeners();
            } else {
                root.innerHTML = renderDashboard();
                setupDashboardListeners();
            }
        }

        function setupUploadListeners() {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('demoBtn').addEventListener('click', loadDemoData);
        }

        function setupDashboardListeners() {
            const headerInput = document.getElementById('fileInputHeader');
            if (headerInput) {
                headerInput.addEventListener('change', handleFileUpload);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                fileName = file.name;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const result = parseCSV(ev.target.result);
                        if (result.length === 0) {
                            alert("No se pudieron leer filas v√°lidas. Verifica el formato del CSV.");
                            return;
                        }
                        appData = result;
                        render();
                    } catch (err) {
                        console.error("Error parsing CSV:", err);
                        alert("Error procesando el archivo: " + err.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadDemoData() {
            const demoRaw = `N√∫mero,Tipo,Especialidad,T√≠tulo,Persona asignada,Compa√±√≠a de la persona asignada,Fecha de notificaci√≥n,Estatus,Prioridad,Ubicaci√≥n
428,Deficiencia,110 - PRO - Control de Calidad,Conexiones firmes y sin fugas,Edwin Aroni,ARONI,26/12/25,Iniciado,Urgent,TORRE>PISO 14>DPTO 1401
429,Deficiencia,110 - PRO - Control de Calidad,Fuga en lavadero,Edwin Aroni,ARONI,26/12/25,Iniciado,High,TORRE>PISO 14>DPTO 1402
430,Seguridad,111 - PRO - Seguridad Industrial,Falta baranda perim√©trica,Victor Andres,PADOVA,27/12/25,Abierto,Urgent,TORRE>PISO 15
431,Acabados,130 - PRO - Pintura,Retoque en muro cortina,Ana Gomez,PINTURAS SA,27/12/25,Cerrado,Medium,TORRE>PISO 05
432,El√©ctrico,120 - PRO - Electricidad,Tablero sin rotular,Maria L,ELECTRO,28/12/25,Iniciado,High,TORRE>PISO 08
433,Deficiencia,110 - PRO - Control de Calidad,Desnivel en contrapiso,Carlos R,CONCRETO MIX,28/12/25,Iniciado,Medium,TORRE>SOTANO 1
434,Seguridad,111 - PRO - Seguridad Industrial,Extintor vencido,Victor Andres,PADOVA,29/12/25,Abierto,High,TORRE>PISO 01
435,Deficiencia,110 - PRO - Control de Calidad,Ventana rayada,Luis Villa,VIDRIOS PERU,30/12/25,Cerrado,Low,TORRE>PISO 14
436,El√©ctrico,120 - PRO - Electricidad,Cable expuesto pasillo,Maria L,ELECTRO,02/01/26,Iniciado,Urgent,TORRE>PISO 02
437,Acabados,130 - PRO - Pintura,Mancha en cielo raso,Ana Gomez,PINTURAS SA,03/01/26,Iniciado,Medium,TORRE>PISO 14
438,Sanitario,140 - PRO - Sanitaria,Tuber√≠as mal selladas,Pedro S√°nchez,SANITARIA PERU,04/01/26,Cerrado,Low,TORRE>PISO 10
439,Estructural,150 - PRO - Estructura,Grieta menor en muro,Roberto Lee,STRUCT ING,05/01/26,Iniciado,High,TORRE>PISO 03
440,Seguridad,111 - PRO - Seguridad Industrial,Salida de emergencia bloqueada,Victor Andres,PADOVA,05/01/26,Abierto,Urgent,TORRE>PISO 12
441,Deficiencia,110 - PRO - Control de Calidad,Piso rayado,Luis Villa,VIDRIOS PERU,06/01/26,Cerrado,Medium,TORRE>PISO 06
442,Acabados,130 - PRO - Pintura,Falta pintura en moldura,Ana Gomez,PINTURAS SA,06/01/26,Iniciado,Low,TORRE>PISO 07`;

            appData = parseCSV(demoRaw);
            fileName = 'LITORAL900_DEMO_26DIC2025.csv';
            render();
        }

        function setFilter(type) {
            filterType = type;
            currentPage = 1;
            render();
        }

        function setTimelineFilter(filter) {
            timelineFilter = filter;
            render();
        }

        function changePage(delta) {
            const analytics = calculateAnalytics(appData, filterType);
            const maxPage = Math.ceil(analytics.raw.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= maxPage) {
                currentPage = newPage;
                render();
            }
        }

        function showChartDetail(chartType, filterValue) {
            const modal = document.getElementById('chartDetailModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            let filtered = appData;
            if (filterType !== 'All') {
                filtered = filtered.filter(d => d['Tipo'] === filterType);
            }
            
            let items = [];
            let titleText = '';
            
            if (chartType === 'floor') {
                items = filtered.filter(d => {
                    let floor = d._piso || 'Sin definir';
                    floor = floor.replace('TORRE>', '').trim();
                    if (!floor) floor = 'Sin definir';
                    return floor === filterValue;
                });
                titleText = `üìç Observaciones en ${filterValue}`;
            } else if (chartType === 'tipo') {
                items = filtered.filter(d => d._tipoLabel === filterValue);
                titleText = `üîß Observaciones de tipo: ${filterValue}`;
            } else if (chartType === 'status') {
                items = filtered.filter(d => d['Estatus'] === filterValue);
                titleText = `üìä Observaciones con estado: ${filterValue}`;
            }
            
            title.textContent = `${titleText} (${items.length})`;
            
            content.innerHTML = `
                <div class="space-y-3">
                    ${items.slice(0, 50).map(row => `
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-mono text-xs font-bold text-slate-600">#${row['N√∫mero'] || 'N/A'}</span>
                                        <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-bold">${row._tipoLabel}</span>
                                        <span class="text-xs font-bold" style="color: ${COLORS_PRIORITY[row['Prioridad']] || '#64748b'}">${row['Prioridad'] || 'N/A'}</span>
                                    </div>
                                    <p class="font-medium text-slate-800">${row['T√≠tulo'] || row['Descripci√≥n'] || 'Sin t√≠tulo'}</p>
                                    <div class="mt-2 flex flex-wrap gap-3 text-xs text-slate-500">
                                        <span>üìç ${row._piso}</span>
                                        <span>üë§ ${row['Persona asignada'] || 'Sin asignar'}</span>
                                        <span>üìÖ ${row._dateObj ? row._dateObj.toLocaleDateString('es-PE') : 'N/A'}</span>
                                    </div>
                                </div>
                                <span class="text-xs font-semibold px-2 py-1 rounded" style="color: ${COLORS_STATUS[row['Estatus']] || '#64748b'}; background: ${COLORS_STATUS[row['Estatus']] ? COLORS_STATUS[row['Estatus']] + '20' : '#64748b20'}">
                                    ${row['Estatus'] || 'N/A'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                    ${items.length > 50 ? `<p class="text-center text-slate-500 text-sm py-4">... y ${items.length - 50} observaciones m√°s</p>` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeChartDetail() {
            document.getElementById('chartDetailModal').classList.add('hidden');
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeChartDetail();
        });

        function toggleRow(idx) {
            const detailRow = document.getElementById(`detail-${idx}`);
            const arrow = document.getElementById(`arrow-${idx}`);
            
            if (detailRow.classList.contains('hidden')) {
                detailRow.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
            } else {
                detailRow.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
